<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR é­”æ³•ä»™å¥³æ£’ (CDN æé€Ÿç‰ˆ)</title>

    <script>
    if (typeof process === 'object' && typeof require === 'function') {
        window._oldModule = window.module;
        window.module = undefined; 
        window.exports = undefined;
        window.__dirname = ''; 
    }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        :root { --glass-bg: rgba(20, 20, 28, 0.85); --accent: #ffd700; }
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; user-select: none; -webkit-user-select: none; }
        
        /* å¼ºåˆ¶è¦†ç›–å±‚ */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #start-btn {
            padding: 15px 40px; font-size: 1.2rem; background: var(--accent); color: #000;
            border: none; border-radius: 30px; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }
        
        #loading-text { color: #fff; margin-top: 20px; font-size: 0.9rem; text-align: center; line-height: 1.5; }
        #debug-console { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 100px; 
            background: rgba(0,0,0,0.5); color: #0f0; font-size: 10px; 
            overflow-y: scroll; pointer-events: none; z-index: 50; display: none;
        }

        /* éšè—è§†é¢‘ï¼Œä¿ç•™ Canvas */
        #input_video { position: absolute; width: 1px; height: 1px; opacity: 0; }
        canvas { position: absolute; top: 0; left: 0; }
        
        /* ç®€å•çš„ UI */
        .ui-layer { position: absolute; top: 20px; width: 100%; text-align: center; z-index: 10; pointer-events: none; }
        .badge { background: rgba(255,255,255,0.2); color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; margin: 0 5px; opacity: 0.5; }
        .badge.active { background: var(--accent); color: black; opacity: 1; font-weight: bold; }
    </style>
</head>
<body>

    <div id="start-overlay">
        <button id="start-btn" onclick="initApp()">ç‚¹å‡»å¼€å§‹é­”æ³•</button>
        <div id="loading-text">å‡†å¤‡å°±ç»ª</div>
    </div>

    <div id="debug-console"></div>

    <div class="ui-layer">
        <span id="b-pinch" class="badge">ç‚¹ç«</span>
        <span id="b-peace" class="badge">æé€Ÿ</span>
        <span id="b-palm" class="badge">æ¢è‰²</span>
    </div>

    <video id="input_video" playsinline webkit-playsinline muted></video>
    <canvas id="bgCanvas"></canvas>
    <canvas id="fgCanvas"></canvas>

<script>
    // --- å±å¹•æ—¥å¿—å·¥å…· (ç”¨äºæ‰‹æœºè°ƒè¯•) ---
    function log(msg) {
        console.log(msg);
        const box = document.getElementById('loading-text');
        if(box) box.innerHTML = msg;
        const debug = document.getElementById('debug-console');
        if(debug) debug.innerHTML += `> ${msg}<br>`;
    }
    window.onerror = (msg) => log("âŒ é”™è¯¯: " + msg);

    // --- æ ¸å¿ƒå˜é‡ ---
    const videoElement = document.getElementById('input_video');
    const bgCanvas = document.getElementById('bgCanvas');
    const fgCanvas = document.getElementById('fgCanvas');
    const bgCtx = bgCanvas.getContext('2d');
    const fgCtx = fgCanvas.getContext('2d');
    let width, height;

    function resize() {
        width = window.innerWidth; height = window.innerHeight;
        bgCanvas.width = fgCanvas.width = width;
        bgCanvas.height = fgCanvas.height = height;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- MediaPipe é…ç½® (CDN æ¨¡å¼) ---
    let hands;
    
    async function initApp() {
        const btn = document.getElementById('start-btn');
        btn.style.display = 'none';
        log("â³ æ­£åœ¨åˆå§‹åŒ– AI å¼•æ“ (CDN)...");

        try {
            hands = new Hands({
                locateFile: (file) => {
                    // å¼ºåˆ¶æŒ‡å‘ CDNï¼Œä¸å†ä½¿ç”¨æœ¬åœ°æ–‡ä»¶
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onResults);

            await startCamera();

        } catch (e) {
            log("âŒ åˆå§‹åŒ–å¤±è´¥: " + e.message);
            btn.style.display = 'block';
            btn.innerText = "é‡è¯•";
        }
    }

    async function startCamera() {
        log("ğŸ“· è¯·æ±‚æ‘„åƒå¤´æƒé™...");
        
        // é™ä½åˆ†è¾¨ç‡è¦æ±‚ä»¥æé«˜å…¼å®¹æ€§
        const constraints = {
            video: { 
                width: { ideal: 640 }, 
                height: { ideal: 480 }, 
                facingMode: "user" 
            },
            audio: false
        };

        try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            videoElement.srcObject = stream;
            
            // Safari å…³é”®ç‚¹ï¼šå¿…é¡»åœ¨ç”¨æˆ·ç‚¹å‡»äº‹ä»¶åç«‹å³è°ƒç”¨ play
            await videoElement.play();
            
            log("ğŸ¤– æ­£åœ¨åŠ è½½æ¨¡å‹ (é¦–æ¬¡åŠ è½½éœ€10ç§’)...");
            document.getElementById('start-overlay').style.display = 'none'; // éšè—é®ç½©ï¼Œä½†ä¿ç•™ log
            
            // å¼€å¯å¾ªç¯
            processVideo();

        } catch (e) {
            log("âŒ æ‘„åƒå¤´é”™è¯¯: " + e.message);
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                log("âš ï¸ å¿…é¡»ä½¿ç”¨ HTTPS è®¿é—®ï¼");
            }
        }
    }

    async function processVideo() {
        // åªæœ‰å½“è§†é¢‘çœŸæ­£æœ‰æ•°æ®æ—¶æ‰å‘é€
        if (!videoElement.paused && !videoElement.ended && videoElement.readyState >= 2) {
            await hands.send({image: videoElement});
        }
        // ä¿æŒå¾ªç¯
        requestAnimationFrame(processVideo);
    }

    // --- æ¸¸æˆé€»è¾‘éƒ¨åˆ† ---
    
    const handInstances = new Map();
    const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff'];
    let colorIdx = 0;
    
    // ç®€å•çš„ç²’å­ç±»
    class Particle {
        constructor(x, y, isTurbo) {
            this.x = x; this.y = y;
            const angle = Math.random() * 6.28;
            const speed = isTurbo ? Math.random()*8+2 : Math.random()*4+1;
            this.vx = Math.cos(angle) * speed;
            this.vy = Math.sin(angle) * speed;
            this.life = 1.0;
            this.color = colors[colorIdx];
        }
        update() {
            this.x += this.vx; this.y += this.vy; this.life -= 0.02;
            this.vy += 0.1; // é‡åŠ›
        }
        draw(ctx) {
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, 6.28); ctx.fill();
        }
    }
    let particles = [];

    function onResults(results) {
        // æ¸…å±
        fgCtx.clearRect(0, 0, width, height);
        bgCtx.fillStyle = 'rgba(0,0,0,0.1)';
        bgCtx.fillRect(0,0,width,height); // æ‹–å½±æ•ˆæœ

        let isPinch = false;
        let isPeace = false;
        let isPalm = false;

        if (results.multiHandLandmarks) {
            for (const landmarks of results.multiHandLandmarks) {
                // è·å–é£ŸæŒ‡å’Œæ‹‡æŒ‡åæ ‡
                const idx = landmarks[8];
                const thm = landmarks[4];
                
                // åæ ‡è½¬æ¢
                const x = (1 - idx.x) * width;
                const y = idx.y * height;
                const tx = (1 - thm.x) * width;
                const ty = thm.y * height;

                // ç®€å•çš„æåˆæ£€æµ‹
                const dist = Math.hypot(x-tx, y-ty);
                if (dist < 50) isPinch = true;

                // ç®€å•çš„æ‰‹åŠ¿æ£€æµ‹ (æ ¹æ®æŒ‡å°–é«˜åº¦)
                const midY = landmarks[12].y * height;
                const ringY = landmarks[16].y * height;
                const wristY = landmarks[0].y * height;
                
                if (idx.y*height < wristY && midY < wristY && ringY > wristY) isPeace = true;
                if (idx.y*height < wristY && midY < wristY && ringY < wristY) isPalm = true;

                // ç»˜åˆ¶å…‰ç‚¹
                fgCtx.fillStyle = '#fff';
                fgCtx.beginPath(); fgCtx.arc(x, y, 10, 0, 6.28); fgCtx.fill();

                // å‘å°„ç²’å­
                if (isPinch || isPeace) {
                    const count = isPeace ? 5 : 2;
                    for(let i=0; i<count; i++) particles.push(new Particle(x, y, isPeace));
                }
            }
        }

        // æ›´æ–°ç²’å­
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.update();
            p.draw(fgCtx);
            if (p.life <= 0) particles.splice(i, 1);
        }

        // ç®€å•çš„æ¢è‰²é€»è¾‘
        if (isPalm && Math.random() > 0.95) {
            colorIdx = (colorIdx + 1) % colors.length;
        }

        // æ›´æ–° UI
        document.getElementById('b-pinch').className = 'badge ' + (isPinch ? 'active' : '');
        document.getElementById('b-peace').className = 'badge ' + (isPeace ? 'active' : '');
        document.getElementById('b-palm').className = 'badge ' + (isPalm ? 'active' : '');
    }

</script>
</body>
</html>