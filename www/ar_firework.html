<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR é­”æ³•ä»™å¥³æ£’ (RPG Maker & ç½‘é¡µç‰ˆ)</title>

    <script>
    // 1. ç¯å¢ƒå…¼å®¹æ€§è¡¥ä¸ï¼šä»…åœ¨ NW.js (RPG Maker) ä¸‹æ‰§è¡Œï¼Œé¿å…å¹²æ‰°æ‰‹æœºæµè§ˆå™¨
    if (typeof process === 'object' && typeof require === 'function') {
        window._oldModule = window.module;
        window.module = undefined; 
        window.exports = undefined;
        window.__dirname = ''; 
        console.log("æ£€æµ‹åˆ° NW.js ç¯å¢ƒï¼Œå·²åº”ç”¨å…¼å®¹æ€§è¡¥ä¸");
    }
    </script>

    <script src="mediapipe/camera_utils.js"></script>
    <script src="mediapipe/control_utils.js"></script>
    <script src="mediapipe/drawing_utils.js"></script>
    <script src="mediapipe/hands.js"></script>

    <style>
        :root {
            --glass-bg: rgba(20, 20, 28, 0.75);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --accent-color: #ffd700;
            --accent-glow: rgba(255, 215, 0, 0.4);
            --text-main: #ffffff;
            --text-sub: rgba(255, 255, 255, 0.7);
        }
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: -apple-system, sans-serif; color: var(--text-main); user-select: none; -webkit-user-select: none; }
        canvas { position: absolute; top: 0; left: 0; }
        #input_video { display: none; }
        .btn-icon { background: var(--glass-bg); border: 1px solid var(--glass-border); color: white; padding: 10px 16px; border-radius: 12px; cursor: pointer; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); font-size: 0.95rem; display: flex; align-items: center; gap: 8px; pointer-events: auto; }
        .top-bar { position: absolute; top: 20px; left: 24px; right: 24px; display: flex; justify-content: space-between; z-index: 60; pointer-events: none; }
        #settings-panel { position: absolute; top: 70px; left: 24px; z-index: 60; background: rgba(18, 18, 24, 0.9); border: 1px solid var(--glass-border); padding: 20px; border-radius: 16px; backdrop-filter: blur(20px); width: 260px; display: none; flex-direction: column; gap: 15px; pointer-events: auto; }
        .panel-section { display: flex; flex-direction: column; gap: 10px; }
        .control-row { display: flex; justify-content: space-between; align-items: center; }
        .toggle-switch { position: relative; width: 44px; height: 24px; appearance: none; background: rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer; }
        .toggle-switch:checked { background: var(--accent-color); }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle-switch:checked::after { transform: translateX(20px); }
        #status-container { position: absolute; top: 20px; left: 0; right: 0; display: flex; justify-content: center; pointer-events: none; z-index: 50; }
        #status-bar { display: flex; gap: 12px; background: var(--glass-bg); padding: 6px 8px; border-radius: 24px; border: 1px solid var(--glass-border); backdrop-filter: blur(12px); }
        .badge { padding: 6px 14px; border-radius: 18px; font-size: 0.85rem; opacity: 0.4; transition: 0.4s; color: rgba(255,255,255,0.8); }
        .badge.active { opacity: 1; background: var(--accent-glow); color: #fff; transform: scale(1.05); }
        #tips { position: absolute; bottom: 30px; width: 100%; text-align: center; z-index: 10; font-size: 0.9rem; color: rgba(255,255,255,0.8); pointer-events: none; }
        .key-gesture { color: var(--accent-color); font-weight: 700; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.1rem; z-index: 100; text-align: center; color: #ccc; }
    </style>
</head>
<body>
    <div id="loading">âœ¨ æ­£åœ¨è¿æ¥é­”æ³•...<br><span style="font-size:0.85em; opacity:0.6">åˆå§‹åŒ–ä¸­</span></div>

    <div class="top-bar">
        <div class="btn-icon" onclick="toggleSettings()"><span>âš™ï¸ è®¾ç½®</span></div>
        <div class="btn-icon" style="border-color: rgba(255,100,100,0.3)" onclick="exitToRPG()"><span>ğŸšª è¿”å›</span></div>
    </div>

    <div id="settings-panel">
        <div class="panel-section">
            <div class="control-row">
                <span style="font-size:0.9rem">åŒæŒæ¨¡å¼ (æ¶ˆè€—æ€§èƒ½)</span>
                <input type="checkbox" id="dual-mode-toggle" class="toggle-switch" onchange="updateSettings()">
            </div>
        </div>
    </div>

    <div id="status-container">
        <div id="status-bar">
            <div class="badge" id="badge-pinch">ğŸ”¥ ç‚¹ç«</div>
            <div class="badge" id="badge-peace">ğŸš€ æé€Ÿ</div>
            <div class="badge" id="badge-palm">ğŸ¨ æ¢è‰²</div>
        </div>
    </div>

    <div id="tips"><p><span class="key-gesture">æåˆ</span>ç‚¹ç‡ƒ Â· <span class="key-gesture">æ¯”è€¶</span>åŠ å¼º Â· <span class="key-gesture">å¼ æ‰‹</span>æ¢è‰²</p></div>

    <video id="input_video" playsinline muted></video>
    <canvas id="bgCanvas"></canvas>
    <canvas id="fgCanvas"></canvas>

<script>
    const videoElement = document.getElementById('input_video');
    const bgCanvas = document.getElementById('bgCanvas');
    const fgCanvas = document.getElementById('fgCanvas');
    const bgCtx = bgCanvas.getContext('2d');
    const fgCtx = fgCanvas.getContext('2d');
    const loadingDiv = document.getElementById('loading');
    let width, height;

    function resize() {
        width = window.innerWidth; height = window.innerHeight;
        bgCanvas.width = fgCanvas.width = width;
        bgCanvas.height = fgCanvas.height = height;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- MediaPipe åˆå§‹åŒ– ---
    const hands = new Hands({
        locateFile: (file) => `./mediapipe/${file}`
    });

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    // æ ¸å¿ƒé€»è¾‘ï¼šå½“ AI æˆåŠŸè¿”å›ç¬¬ä¸€å¸§ç»“æœæ—¶éšè—åŠ è½½åŠ¨ç”»
    hands.onResults((results) => {
        if (loadingDiv.style.display !== 'none') loadingDiv.style.display = 'none';
        updateHands(results);
    });

    // --- æ‘„åƒå¤´å¯åŠ¨ (é’ˆå¯¹ Safari ä¼˜åŒ–) ---
    async function startCamera() {
        // HTTPS æ£€æŸ¥
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            loadingDiv.innerHTML = "âš ï¸ å¯åŠ¨å¤±è´¥<br><span style='font-size:0.85em'>ç½‘é¡µç‰ˆå¿…é¡»ä½¿ç”¨ HTTPS è®¿é—®æ‰èƒ½å¼€å¯æ‘„åƒå¤´</span>";
            return;
        }

        try {
            loadingDiv.innerHTML = "âœ¨ æ­£åœ¨ç”³è¯·æ‘„åƒå¤´æƒé™...";
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: "user" }
            });

            videoElement.srcObject = stream;
            window.streamReference = stream;
            
            // å¿…é¡»ç­‰å¾…è§†é¢‘å…ƒæ•°æ®åŠ è½½å¹¶è°ƒç”¨ play()
            await new Promise((resolve) => videoElement.onloadedmetadata = resolve);
            await videoElement.play();

            loadingDiv.innerHTML = "âœ¨ æ­£åœ¨åŠ è½½ AI æ¨¡å‹...<br><span style='font-size:0.8em'>é¦–æ¬¡åŠ è½½çº¦éœ€ 10-20 ç§’</span>";
            
            // å¯åŠ¨å¾ªç¯ï¼šå¢åŠ  readyState æ£€æŸ¥
            const sendFrame = async () => {
                // readyState >= 2 è¡¨ç¤º Safari å·²ç»æœ‰è¶³å¤Ÿçš„å¸§æ•°æ®å¯ä»¥å‘é€ç»™ AI
                if (!videoElement.paused && videoElement.readyState >= 2) {
                    await hands.send({image: videoElement});
                }
                requestAnimationFrame(sendFrame);
            };
            sendFrame();

        } catch (error) {
            loadingDiv.innerHTML = `âš ï¸ æ‘„åƒå¤´å¼€å¯å¤±è´¥<br><span style='font-size:0.7em'>${error.message}</span>`;
        }
    }

    // --- å…¶ä½™é€»è¾‘ç®€åŒ– ---
    let handInstances = new Map();
    // (æ­¤å¤„ä¿ç•™ä½ åŸæœ‰çš„ Particle, HandInstance ç±»ä»¥åŠ loop å‡½æ•°é€»è¾‘)
    // ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œå»ºè®®ç›´æ¥å¤ç”¨ä½ åŸæ–‡ä»¶ä¸­ class Particle å’Œ class HandInstance ä¹‹åçš„ä»£ç 
    // åªéœ€ç¡®ä¿åœ¨ loop å‡½æ•°é‡Œæ£€æŸ¥ç»˜åˆ¶æ—¶å®½åº¦é«˜åº¦å³å¯

    function exitToRPG() {
        if (window.streamReference) window.streamReference.getTracks().forEach(t => t.stop());
        window.parent.postMessage("CLOSE_AR_WINDOW", "*");
    }

    function toggleSettings() {
        const p = document.getElementById('settings-panel');
        p.style.display = p.style.display === 'flex' ? 'none' : 'flex';
    }

    function updateSettings() {
        const dual = document.getElementById('dual-mode-toggle').checked;
        hands.setOptions({ maxNumHands: dual ? 2 : 1 });
    }

    // (æ­¤å¤„åº”åŒ…å«ä½ åŸæœ‰çš„ Particle ç±»ã€æ‰‹åŠ¿é€»è¾‘åŠæ¸²æŸ“ loopï¼Œé€»è¾‘ä¸å˜)
    // ... [ä¿ç•™åŸæ–‡ä»¶ä¸­ class Particle åˆ° loop() çš„æ‰€æœ‰é€»è¾‘] ...

    startCamera();
</script>
</body>
</html>