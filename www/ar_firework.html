<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR é­”æ³•è¯Šæ–­ç‰ˆ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body { margin: 0; background: black; color: white; font-family: monospace; overflow: hidden; }
        
        /* è¯Šæ–­æ§åˆ¶å° */
        #console-log {
            position: absolute; top: 0; left: 0; width: 100%; height: 50%;
            background: rgba(0,0,0,0.8); overflow-y: scroll; 
            padding: 10px; font-size: 12px; z-index: 999; pointer-events: none;
            border-bottom: 1px solid #333;
        }
        .log-info { color: #0f0; }
        .log-warn { color: #ff0; }
        .log-err { color: #f00; font-weight: bold; font-size: 14px; }

        /* å¯åŠ¨æŒ‰é’® */
        #start-btn {
            position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%);
            padding: 20px 40px; font-size: 20px; background: #ffd700; color: black;
            border: none; border-radius: 10px; z-index: 1000; cursor: pointer;
        }

        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        video { position: absolute; opacity: 0; width: 1px; height: 1px; }
    </style>
</head>
<body>

    <div id="console-log">=== ç³»ç»Ÿæ—¥å¿— (æˆªå›¾å‘ç»™æˆ‘) ===<br></div>
    <button id="start-btn" onclick="startApp()">ğŸ‘‰ ç‚¹å‡»å¯åŠ¨æ£€æµ‹ ğŸ‘ˆ</button>
    
    <video id="input_video" playsinline webkit-playsinline muted></video>
    <canvas id="output_canvas"></canvas>

<script>
    // --- æ—¥å¿—å·¥å…· ---
    const logger = document.getElementById('console-log');
    function log(msg, type = 'info') {
        const line = document.createElement('div');
        line.className = 'log-' + type;
        line.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logger.appendChild(line);
        logger.scrollTop = logger.scrollHeight;
        console.log(msg);
    }
    window.onerror = function(msg, url, line) {
        log(`å…¨å±€é”™è¯¯: ${msg} (è¡Œå·:${line})`, 'err');
    };

    // --- æ ¸å¿ƒå˜é‡ ---
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    let hands;
    let camera;

    // --- åˆå§‹åŒ– ---
    async function startApp() {
        document.getElementById('start-btn').style.display = 'none';
        log("1. å¼€å§‹åˆå§‹åŒ–...");

        // 1. è®¾ç½®ç”»å¸ƒå°ºå¯¸
        canvasElement.width = window.innerWidth;
        canvasElement.height = window.innerHeight;

        try {
            // 2. åˆå§‹åŒ– MediaPipe
            log("2. åˆ›å»º Hands å®ä¾‹...");
            hands = new Hands({
                locateFile: (file) => {
                    const url = `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                    log(`èµ„æºå®šä½: ${file} -> CDN`, 'info');
                    return url;
                }
            });

            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 0, // é™ä½å¤æ‚åº¦ä»¥æå‡é€Ÿåº¦
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onResults);
            log("3. Hands å®ä¾‹åˆ›å»ºå®Œæˆ");

            // 3. å¯åŠ¨æ‘„åƒå¤´
            log("4. è¯·æ±‚æ‘„åƒå¤´æƒé™...");
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user', width: 640, height: 480 },
                audio: false
            });
            
            videoElement.srcObject = stream;
            
            // å…³é”®ï¼šç­‰å¾…è§†é¢‘è½½å…¥
            log("5. ç­‰å¾…è§†é¢‘æµæ•°æ®...");
            await new Promise((resolve) => {
                videoElement.onloadedmetadata = () => {
                    log("-> è§†é¢‘å…ƒæ•°æ®å·²åŠ è½½");
                    resolve();
                };
            });
            
            await videoElement.play();
            log("6. è§†é¢‘å¼€å§‹æ’­æ”¾");

            // 4. å‘é€æ•°æ®ç»™ AI
            log("7. å¼€å§‹å‘é€å¸§ç»™ AI æ¨¡å‹ (æœ€è€—æ—¶æ­¥éª¤)...");
            log("âš ï¸ å¦‚æœå¡åœ¨è¿™é‡Œè¶…è¿‡ 20 ç§’ï¼Œè¯´æ˜ç½‘ç»œæ— æ³•ä¸‹è½½ AI æ¨¡å‹æ–‡ä»¶", 'warn');
            
            sendFrameLoop();

        } catch (error) {
            log("âŒ è‡´å‘½é”™è¯¯: " + error.message, 'err');
            log("æç¤º: å¦‚æœæ˜¯ NotAllowedErrorï¼Œè¯·å…è®¸æ‘„åƒå¤´æƒé™ã€‚", 'warn');
        }
    }

    async function sendFrameLoop() {
        if (!videoElement.paused && !videoElement.ended) {
            try {
                // åªæœ‰å½“è§†é¢‘å‡†å¤‡å¥½æ—¶æ‰å‘é€
                if (videoElement.readyState >= 2) {
                    await hands.send({image: videoElement});
                } else {
                    log("ç­‰å¾…è§†é¢‘æµç¼“å†²...", 'warn');
                }
            } catch (e) {
                log("âŒ AI å¤„ç†å‡ºé”™: " + e.message, 'err');
                return; // åœæ­¢å¾ªç¯
            }
        }
        requestAnimationFrame(sendFrameLoop);
    }

    let firstResult = true;
    function onResults(results) {
        if (firstResult) {
            log("âœ… æˆåŠŸï¼AI æ¨¡å‹å·²åŠ è½½å¹¶è¿è¡Œï¼", 'info');
            // éšè—æ—¥å¿—ï¼Œå¼€å§‹æ˜¾ç¤ºç”»é¢
            document.getElementById('console-log').style.height = '100px'; 
            firstResult = false;
        }

        // ç®€å•ç»˜åˆ¶
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
        
        if (results.multiHandLandmarks) {
            for (const landmarks of results.multiHandLandmarks) {
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 5});
                drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2});
            }
        }
        canvasCtx.restore();
    }
</script>
</body>
</html>